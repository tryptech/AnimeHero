<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- CSS only -->
	<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
	rel="stylesheet"
		crossorigin="anonymous">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://unpkg.com/encoding-japanese@2.2.0/encoding.min.js"></script>

<script>
	$(document).ready(function(){
		$("#myInput").on("keyup", function() {
		var value = $(this).val().toLowerCase();
		$("#song_table tr").filter(function() {
			$(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
		});
		});
	});

	document.addEventListener('DOMContentLoaded', (event) => {
    const htmlElement = document.documentElement;
    const switchElement = document.getElementById('darkModeSwitch');

    // Set the default theme to dark if no setting is found in local storage
    const currentTheme = localStorage.getItem('bsTheme') || 'dark';
    htmlElement.setAttribute('data-bs-theme', currentTheme);
    switchElement.checked = currentTheme === 'dark';

    switchElement.addEventListener('change', function () {
        if (this.checked) {
            htmlElement.setAttribute('data-bs-theme', 'dark');
            localStorage.setItem('bsTheme', 'dark');
        } else {
            htmlElement.setAttribute('data-bs-theme', 'light');
            localStorage.setItem('bsTheme', 'light');
        }
    });
});
</script>

<style>

</style>

</head>
<body>
<div class="container">
	<nav class="navbar clearfix flex-row-reverse">
		<div class="form-check form-switch mt-2 float-end">
			<input class="form-check-input" type="checkbox" id="darkModeSwitch" checked>
			<label class="form-check-label" for="darkModeSwitch">Dark Mode</label>
		</div>
	</nav>

	<h1 class="mx-auto text-center">Anime Hero Tracklist</h1>
	<h6 class="mx-auto text-center d-block mb-4">
		by tryptech <div class="vr"></div> 
		<a href="https://twitter.com/yo_tryptech" target="_blank" rel="noopener">twitter</a> <div class="vr"></div> 
		<a href="https://bsky.app/profile/tryp.tech" target="_blank" rel="noopener">bluesky</a>
	</h6>
	<h5 class="mx-auto text-center d-block mb-4">One song, one shot. If you pass, you get a sticker.<br>
		I don't guarantee any difficulties other than Expert.</h5>
	<small class="d-block text-center text-muted mb-3 mx-auto">
		While you're here, check out the game I'm working on: <a href="https://waa.ai/chrono-gear" target="_blank" rel="noopener">Chrono Gear: Warden of Time</a>
	</small>

	<div id="filefind"></div>
	<hr>

    <div class="input-group mb-3">
        <div class="form-floating flex-grow-1">
            <input id="myInput" type="text" placeholder="Search.." class="form-control form-control-lg">
            <label for="myInput">Search</label>
        </div>
        <button id="filterLikes" class="btn btn-outline-primary" data-bs-toggle="button" onclick="filter_likes()">Toggle Starred Items</button>
    </div>
	<p id="demo"></p>
	<div class="table-responsive">
		<table class="table table-striped" id="songTable">
			<thead class="thead-dark">
				<tr>
					<th class="fav"></th>
					<th class="name">Name</th>
					<th class="length d-none d-sm-table-cell">Length</th>
					<th class="artist d-none d-sm-table-cell">Artist</th>
					<th class="album d-none d-xl-table-cell">Album</th>
					<th class="year d-none d-lg-table-cell">Year</th>
					<th class="genre d-none d-xl-table-cell">Genre</th>
					<th class="charter d-none d-xxl-table-cell">Charter</th>
					<th class="lyrics d-none d-xl-table-cell">Has Lyrics</th>
				</tr>
			</thead>
			<tbody id="song_table">
			</tbody>	
		</table>
	</div>
</div>

<script>

function checksum(s)
{
	var chk = 0x12345678;
	var len = s.length;
	for (var i = 0; i < len; i++) {
		chk += (s.charCodeAt(i) * (i + 1));
	}

	return (chk & 0xffffffff).toString(16);
}

function filter_likes() {
	console.log('\u2605');
	if ( localStorage.getItem('filter_likes') ) {
		$("#song_table tr").filter(function() {
			$(this).toggle($(this).children().first().text().indexOf('') > -1)
		});
		localStorage.removeItem('filter_likes');
	} else {
		$("#song_table tr").filter(function() {
			$(this).toggle($(this).children().first().text().indexOf('\u2605') > -1)
		});
		localStorage.setItem('filter_likes', 'poof');
	}
}

function load_table(data) {
	const myObj = JSON.parse(data).sort((a, b) => (a.Name > b.Name ? 1 : -1));
	let text = "";
	let index = 0;

	for (let x in myObj) {
		var song_id = checksum(JSON.stringify(myObj[x]));
		var like_state = check_like(song_id);

		if (like_state == 1) {
			var like_htmlout = '&#9733;'
		} else {
			var like_htmlout = '&#9734;'
		}

		var time = msToTime(myObj[x].songlength);

		text += `<tr id="row-${index}">`;
		text += '<td class="fav align-middle"><button id="' + song_id + '" onclick="like(this.id)" style="border:none;background:none;">' + like_htmlout + '</button></td>';
		text += `<td class='name align-middle'>
	<div class="d-flex flex-column">
		<div>${fix(myObj[x].Name)}</div>
		<div class="d-inline-flex">
			<div class="d-block d-sm-none text-muted flex-grow-1">${myObj[x].Artist}</div>
			<div class="d-block d-sm-none text-muted ms-3 me-1">${time}</div>
		</div>
	</div>
</td>`;
		text += "<td class='length align-middle d-none d-sm-table-cell'>" + time + "</td>";
		text += "<td class='artist align-middle d-none d-sm-table-cell'>" + myObj[x].Artist + "</td>";
		text += "<td class='album align-middle d-none d-xl-table-cell'>" + myObj[x].Album + "</td>";
		text += "<td class='year align-middle d-none d-lg-table-cell'>" + myObj[x].Year + "</td>";
		text += "<td class='genre align-middle d-none d-xl-table-cell'>" + myObj[x].Genre + "</td>";
		text += "<td class='charter align-middle d-none d-xxl-table-cell'>" + myObj[x].Charter + "</td>";
		text += "<td class='lyrics align-middle d-none d-xl-table-cell'>" + myObj[x].lyrics + "</td>";
		text += "</tr>";
		index++;
	}
	document.getElementById("song_table").innerHTML = text;
	localStorage.removeItem('filter_likes');
	setUpSort();
}

function check_like(song_id) {
	if (localStorage.getItem("like_status_" + song_id)) {
		console.log("Found like status for " + song_id);
		return localStorage.getItem("like_status_" + song_id);
	} else {
		return 0;
	}
}

function like(song_id) {
	console.log("Toggling like for " + song_id);
	var like_state = check_like(song_id);

	if (like_state == 1) {
		var htmlout = '&#9734;'
		like_state = 0;
	} else {
		var htmlout = '&#9733;'
		like_state = 1;
	}
	localStorage.setItem("like_status_" + song_id, like_state);

	document.getElementById(song_id).innerHTML = htmlout;
}

function manual_load(){
	let text = '<h3>Choose songs.json file...</h3><input type="file" id="myFile">';
	document.getElementById("filefind").innerHTML = text;
	
	if (localStorage.songdata) {
		load_table(localStorage.songdata);
	} 

	var input = document.getElementById("myFile");
	input.addEventListener("change", function () {
	if (this.files && this.files[0]) {
		var myFile = this.files[0];
		var reader = new FileReader();
		
		reader.addEventListener('load', function (e) {
			load_table(e.target.result);
			localStorage.songdata = e.target.result;
		});
		
		reader.readAsBinaryString(myFile);
	}	 
	});
}

function msToTime(duration) {
	var milliseconds = Math.floor((duration % 1000) / 100),
		seconds = Math.floor((duration / 1000) % 60),
		minutes = Math.floor((duration / (1000 * 60)) % 60),
		hours = Math.floor((duration / (1000 * 60 * 60)) % 24);

	//hours = (hours < 10) ? "0" + hours : hours;
	//minutes = (minutes < 10) ? "0" + minutes : minutes;
	seconds = (seconds < 10) ? "0" + seconds : seconds;

	return minutes + ":" + seconds;
}

function fix(s) {
	var unicodeArray = Encoding.stringToCode(s);
	return Encoding.convert(unicodeArray, {
		from: 'AUTO',
		to: 'UNICODE',
		type: 'string'
	});
}

const getCellValue = (tr, idx) => tr.children[idx].innerText || tr.children[idx].textContent;

const comparer = (idx, asc) => (a, b) => ((v1, v2) => 
    v1 !== '' && v2 !== '' && !isNaN(v1) && !isNaN(v2) ? v1 - v2 : v1.toString().localeCompare(v2)
    )(getCellValue(asc ? a : b, idx), getCellValue(asc ? b : a, idx));

function setUpSort() {
	// do the work...
	document.querySelectorAll('th').forEach(th => th.addEventListener('click', (() => {
	const table = th.closest('table');
	const tbody = table.querySelector('tbody');
	Array.from(tbody.querySelectorAll('tr'))
		.sort(comparer(Array.from(th.parentNode.children).indexOf(th), this.asc = !this.asc))
		.forEach(tr => tbody.appendChild(tr) );
	})));
}

fetch('./songs.json')
	.then(response => response.text())
	.then(data => load_table(data))
	.catch((error) => manual_load());

</script>

<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
	crossorigin="anonymous"></script>

</body>
</html>
