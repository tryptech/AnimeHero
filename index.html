<!DOCTYPE html>
<html>
<head>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- CSS only -->
	<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We"
		crossorigin="anonymous">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>
$(document).ready(function(){
	$("#myInput").on("keyup", function() {
	var value = $(this).val().toLowerCase();
	$("#song_table tr").filter(function() {
		$(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
	});
	});
});
</script>



</head>
<body>
<div class="container">
	<h2>Search Anime Hero Songs.</h2>

	<div id="filefind"></div>
	<hr>

	<input id="myInput" type="text" placeholder="Search..">
	<button id="filterLikes" onclick="filter_likes()">Toggle Starred Items</button>
	<br><br>
	<p id="demo"></p>
	<table class="table table-striped table-responsive" id="songTable">
	<thead class="thead-dark">
	<tr>
		<th onclick='sortTable(0)'></th>
		<th onclick='sortTable(1)'>Name</th>
		<th onclick='sortTable(2)'>Length</th>
		<th onclick='sortTable(3)'>Artist</th>
		<th onclick='sortTable(4)'>Album</th>
		<th onclick='sortTable(5)'>Year</th>
		<th onclick='sortTable(6)'>Genre</th>
		<th onclick='sortTable(7)'>Charter</th>
		<th onclick='sortTable(8)'>Has Lyrics</th>
	</tr>
	</thead>
	<tbody id="song_table">
	</tbody>	
	</table>
</div>

<script>

function checksum(s)
{
	var chk = 0x12345678;
	var len = s.length;
	for (var i = 0; i < len; i++) {
		chk += (s.charCodeAt(i) * (i + 1));
	}

	return (chk & 0xffffffff).toString(16);
}

function filter_likes() {
	console.log('\u2605');
	if ( localStorage.getItem('filter_likes') ) {
		$("#song_table tr").filter(function() {
			$(this).toggle($(this).text().indexOf('') > -1)
		});
		localStorage.removeItem('filter_likes');
	} else {
		$("#song_table tr").filter(function() {
			$(this).toggle($(this).text().indexOf('\u2605') > -1)
		});
		localStorage.setItem('filter_likes', 'poof');
	}
}

function load_table(data) {
	const myObj = JSON.parse(data);
	let text = "";
	let index = 0;

	for (let x in myObj) {
	var song_id = checksum(JSON.stringify(myObj[x]));
	var like_state = check_like(song_id);

	if (like_state == 1) {
		var like_htmlout = '&#9733;'
	} else {
		var like_htmlout = '&#9734;'
	}

	var time = msToTime(myObj[x].songlength);

	text += "<tr>";
	text += '<td><button id="' + song_id + '" onclick="like(this.id)" style="border:none;background:none;">' + like_htmlout + '</button></td>';
	text += "<td>" + myObj[x].Name + "</td>";
	text += "<td>" + time + "</td>";
	text += "<td>" + myObj[x].Artist + "</td>";
	text += "<td>" + myObj[x].Album + "</td>";
	text += "<td>" + myObj[x].Year + "</td>";
	text += "<td>" + myObj[x].Genre + "</td>";
	text += "<td>" + myObj[x].Charter + "</td>";
	text += "<td>" + myObj[x].lyrics + "</td>";
	text += "</tr>";
	index++;
	}
	document.getElementById("song_table").innerHTML = text;
	localStorage.removeItem('filter_likes');
	sortTable(1);
}

function check_like(song_id) {
	if (localStorage.getItem("like_status_" + song_id)) {
		console.log("Found like status for " + song_id);
		return localStorage.getItem("like_status_" + song_id);
	} else {
		return 0;
	}
}

function like(song_id) {
	console.log("Toggling like for " + song_id);
	var like_state = check_like(song_id);

	if (like_state == 1) {
		var htmlout = '&#9734;'
		like_state = 0;
	} else {
		var htmlout = '&#9733;'
		like_state = 1;
	}
	localStorage.setItem("like_status_" + song_id, like_state);

	document.getElementById(song_id).innerHTML = htmlout;
}

function manual_load(){
	let text = '<h3>Choose songs.json file...</h3><input type="file" id="myFile">';
	document.getElementById("filefind").innerHTML = text;
	
	if (localStorage.songdata) {
		load_table(localStorage.songdata);
	} 

	var input = document.getElementById("myFile");
	input.addEventListener("change", function () {
	if (this.files && this.files[0]) {
		var myFile = this.files[0];
		var reader = new FileReader();
		
		reader.addEventListener('load', function (e) {
			load_table(e.target.result);
			localStorage.songdata = e.target.result;
		});
		
		reader.readAsBinaryString(myFile);
	}	 
	});
}

function msToTime(duration) {
	var milliseconds = Math.floor((duration % 1000) / 100),
		seconds = Math.floor((duration / 1000) % 60),
		minutes = Math.floor((duration / (1000 * 60)) % 60),
		hours = Math.floor((duration / (1000 * 60 * 60)) % 24);

	//hours = (hours < 10) ? "0" + hours : hours;
	//minutes = (minutes < 10) ? "0" + minutes : minutes;
	seconds = (seconds < 10) ? "0" + seconds : seconds;

	return minutes + ":" + seconds;
}

function sortTable(n) {
	var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
	table = document.getElementById("songTable");
	switching = true;
	// Set the sorting direction to ascending:
	dir = "asc";
	/* Make a loop that will continue until
	no switching has been done: */
	while (switching) {
		// Start by saying: no switching is done:
		switching = false;
		rows = table.rows;
		/* Loop through all table rows (except the
		first, which contains table headers): */
		for (i = 1; i < (rows.length - 1); i++) {
			// Start by saying there should be no switching:
			shouldSwitch = false;
			/* Get the two elements you want to compare,
			one from current row and one from the next: */
			x = rows[i].getElementsByTagName("TD")[n];
			y = rows[i + 1].getElementsByTagName("TD")[n];
			/* Check if the two rows should switch place,
			based on the direction, asc or desc: */
			if (dir == "asc") {
			if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
				// If so, mark as a switch and break the loop:
				shouldSwitch = true;
				break;
			}
			} else if (dir == "desc") {
			if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
				// If so, mark as a switch and break the loop:
				shouldSwitch = true;
				break;
			}
		}
	}
	if (shouldSwitch) {
		/* If a switch has been marked, make the switch
		and mark that a switch has been done: */
		rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
		switching = true;
		// Each time a switch is done, increase this count by 1:
		switchcount ++;
	} else {
		/* If no switching has been done AND the direction is "asc",
		set the direction to "desc" and run the while loop again. */
		if (switchcount == 0 && dir == "asc") {
		dir = "desc";
		switching = true;
		}
	}
	}
}

fetch('./songs.json')
	.then(response => response.text())
	.then(data => load_table(data))
	.catch((error) => manual_load());

</script>

<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"
integrity="sha384-U1DAWAznBHeqEIlVSCgzq+c9gqGAJn5c/t99JyeKa9xxaYpSvHU5awsuZVVFIhvj"
	crossorigin="anonymous"></script>

</body>
</html>
